# 建筑高度估计任务设计方案 (Building Height Estimation)

## 1. 任务概述
让 Agent 在街景环境中，对其视野内的特定建筑进行高度估计。
*   **输入**：初始全景图位置，目标建筑的方位或 ID（指令中指定要面向的方向）。
*   **输出**：建筑的估计高度（米）或层数（Floors）。
*   **核心能力**：3D 几何感知、透视关系理解、参考物（如车、人、树）比例推理。

## 2. 真值获取方案 (Ground Truth)
基于用户提到的 "Google 2.5D Dataset" 及相关 API，我们将采用以下方案作为真值来源：

### A. 主要数据源：Google Open Buildings 2.5D Temporal Dataset
Google 最近发布的 **Open Buildings 2.5D Temporal Dataset** 提供了从 2016 年至今的建筑高度估算数据。
*   **优点**：
    *   包含 **高度 (Height)** 和 **基底高度 (Building footprint)**。
    *   **时间维度 (Temporal)**：可以查询特定年份的高度（这解决了全景图年份匹配的问题）。
    *   覆盖广：非著名建筑（普通民居、商业楼）数据丰富。

### B. 备选/辅助：Google Solar API
如果需要实时 API 调用，Google Maps Platform 的 **Solar API** 提供 `buildingInsights`，其中包含：
*   屋顶模型和高度数据。
*   适合用来交叉验证。

## 3. 应对视觉难点：垂直视野与移动
用户提到的“垂直视野 (Vertical FOV)”受限确实是全景图的痛点，尤其是近距离观察高楼时。

### 策略：扩大移动范围 (Expanded Movement)
我们**不**强制 Agent 必须站在楼底下抬头看（这会导致严重的透视畸形和顶部截断）。
*   **机制**：允许 Agent 在目标建筑周围 **40米** 的半径内自由移动。
*   **白名单设计 (BFS & Connectivity)**：
    *   **起始点**：选择距离目标建筑几何中心（Centroid）或投影点**最近**的全景图作为起始点（Spawn Point）。
    *   **搜索策略**：从起始点开始进行 **BFS（广度优先搜索）**，向各个方向扩散。
    *   **连通性检查**：如果选定的起始全景图没有连接（Links）或其他全景图不可达（Isolated Node），则**直接舍弃该目标/建筑**，重新寻找下一个目标。
    *   **终止条件**：距离起始点 > 40米 或 无更多连接。

## 4. 数据一致性与筛选 (Year & Fame)

### A. 年份一致性 (Temporal Consistency)
用户提到的“年份”非常关键。
*   **原则**：全景图年份 ($Y_{pano}$) 必须与 2.5D 数据源的年份 ($Y_{data}$) 保持一致，或者在该时间段内建筑未发生变化。
*   **筛选逻辑**：
    *   选择 **2018年以后** 的全景图（画质好，且与 2.5D Dataset 2016-2023 的重合度高）。
    *   **Strict Mode**：$|Y_{pano} - Y_{data}| \le 2$ years。避免出现“数据里是高楼，图里是工地”的情况。

### B. "非著名建筑" (Generic Buildings)
为了测试 Agent 的泛化能力而非记忆能力：
*   **采样策略**：
    *   避开地标性 POI（不选 "Eiffel Tower", "Empire State Building"）。
    *   使用 **Random Geopoint Sampling** 结合 **Building Footprint**。
    *   在居民区、工业区、普通商业街随机撒点，获取最近的 Building ID。
    *   这类建筑通常没有维基百科词条，Agent 必须依靠视觉推理。

## 5. 任务交互流程
1.  **Spawn**：直接选择距离目标建筑最近的全景图位置。
2.  **Instruction Generation (Visual Localization & Direct Estimation)**：
    *   **难点 1 (Localization)：我怎么知道该看哪里？**
        *   **计算方位 (Bearing)**：根据 `Spawn Pano (lat, lng)` 和 `Building Centroid (lat, lng)` 计算绝对方位角 (Heading)。
        *   **坐标转换**：将该 3D 方位角映射到全景图的像素坐标 (x, y)，通常假设 Pitch 为正值（仰视）。
        *   **指令提示**：将计算出的方位角转换为自然语言方向词（如 *"to your North-East"*）加入 Instruction。
    *   **难点 2 (Direct Prompt)：直接让 Agent 估计高度**
        *   **直接提问，不再描述外观**：面向目标方向，向 Agent 明确要求“估计你面前这栋建筑的高度（米）/层数，并说出 1-2 句依据（如层数、窗格、车/人参考）”。
        *   **提示 Agent 的可用线索**：
            *   估算可见层数并乘以平均层高（住宅 3m、商业 3.6m，可在 Prompt 中给出）。
            *   结合路灯、汽车、行人、树木等典型高度做比例推断，注意透视缩放。
            *   若画面中有多栋建筑，默认取视野中央、最高或占比最大的立面。
    *   **最终指令示例**：
        *   *"Facing the building to your **North-East** (approx. 45° relative to North), estimate the height of the main building in front of you in meters. Answer with one number and a short rationale (floors, reference objects)."*
3.  **Action**：
    *   Agent 可以旋转观察。
    *   Agent 可以沿着街道移动（Move Forward/Back），寻找最佳视角（比如避开树木遮挡，或者退得更远以减小仰角）。
4.  **Answer**：
    *   **Output**：精确的米数 (Exact Height in Meters, e.g., *"32.5"*).
    *   **Evaluation**：**±10% Tolerance**。 (例如真值 30m，预测值在 [27m, 33m] 范围内即视为正确)。
    *   *注：不再要求通过楼层估算，直接输出高度。*

## 6. 难点总结与应对
| 难点 | 应对方案 |
| :--- | :--- |
| **真值获取** | 使用 Open Buildings 2.5D Temporal Dataset (匹配时间戳)。 |
| **顶部截断 (Vertical FOV)** | 允许 Agent 移动 (Move)，寻找更远/更好的观测点。 |
| **遮挡 (Occlusion)** | 确保目标建筑至少在 2-3 个相邻全景图中由于不同角度可见 (Cross-Verification)。 |
| **准确度评估** | 仅要求 **高度 (Meters)**，设定 **±10%** 的容错范围以应对测量/观测误差。 |

## 7. 任务生成与存储 (Pipeline & Storage)
*   **存储路径**：新建专门的文件夹 `tasks_building_height/` 专门用于存储此类任务的数据。
*   **图像预下载 (Image Pre-fetching)**：
    *   **时机**：在生成 Whitelist 后，**立即调用 API** 下载白名单中（包括 Spawn 点和所有通过 BFS 找到的点）的图像。
    *   **参数**：默认下载 **Level 2** (Zoom Level 2) 的全景图切片。
    *   **并发控制 (Concurrency)**：**强制使用并发**调用 API（如 `asyncio.gather`），**并发数 (Workers) 设置为 8**，以提高海量全景图的下载效率。
    *   **目的**：确保 VLN 任务执行时直接读取本地图片，避免实时网络请求延迟，并为 Agent 的高度估计提供高清晰度素材。
